#!/usr/bin/env perl
use strict;
use HTML::Template;

die "usage: $0 templateFile [--no-head|--no-footer] VARX=VALX VARY=VALY...\n" unless @ARGV>0;

my $template;
my $fileName = shift @ARGV;

if($fileName eq "-") {
    open my $fh, '<&STDIN';
    $template = HTML::Template->new(filehandle => $fh);
}else{
    $fileName = "../eman.seeds/$fileName";
    $template = HTML::Template->new(filename => "$fileName");
}

unless(grep {/--no-header/} @ARGV){
print <<'EOF';
#!/bin/bash -x
################################################################################################
# Standard command header
################################################################################################
echo "=============================="
echo "== Started:   "`date '+%Y%m%d-%H%M'`
echo "== Hostname:  "`hostname`
echo "== Directory: "`pwd`
echo "=============================="


mydir=$(pwd)
PLAYGROUND=$(eman path)

set -o pipefail
set -x # detailed logging of eman.command
function die() { echo "$@" >&2 ; eman fail $mydir ; exit 1 ; }
echoerr() { echo "$@" 1>&2; }
#renice 10 $$
ulimit -c 1 # core files limited to 1 byte
################################################################################################
# The real code starts here
################################################################################################


# Set default variables:
###############################################################################################
###############################################################################################
###############################################################################################
###############################################################################################
###############################################################################################
###############################################################################################












EOF
}

foreach my $pair ( grep {/=/} @ARGV ){
	$pair=~/^(.*?)=(.*)$/;
	my $varName = $1;
	my $varVal = $2;
	$template->param($varName => $varVal);
}

print $template->output;

unless(grep {/--no-footer/} @ARGV){
print <<'EOF';











###############################################################################################
###############################################################################################
###############################################################################################
###############################################################################################
###############################################################################################
###############################################################################################
################################################################################################
# Standard command footer
################################################################################################
set +x # no more detailed logging of eman.command
echo Done.
eman succeed $mydir
echo "=============================="
echo "== Ended:     "`date '+%Y%m%d-%H%M'`
echo "== Hostname:  "`hostname`
echo "== Directory: "`pwd`
echo "=============================="
EOF
}



