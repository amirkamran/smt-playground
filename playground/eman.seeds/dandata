#!/bin/bash
# eman step that prepares Dan's current selection of corpora for WMT experiments
# This seed script creates steps capable of selecting corpora for variable language pairs, e.g. cs-en, de-en, es-en, fr-en.
# All input paths are hardwired. The only input variables are the two language codes.
# Currently the source location is Dan's own augmented_corpora folder at
# /net/work/people/zeman/wmt/augmented_corpora
# The step selects and copies/symlinks the following corpora (tokenized plain text, gzipped):
# - source training data
# - target training data
# - source alignment training data (could use different factor than the above)
# - target alignment training data
# - target language model training data (might be larger than just the target side of the parallel corpus)
# - source development data (used for MERT)
# - target development data (used for MERT)
# - source test data
# - target test data (one reference translation assumed)

function die() { echo "$@" >&2; exit 1; }
set -o pipefail  # safer pipes

# Ensure all the required variables are set (or provide the default).
# Note that we also require STATMT, which is constant w.r.t. individual experiments.
# However, we do not define it as one of the variables defining the step (because its value will be the same in all our experiments).
# It points to the current user's working copy of the StatMT repository. You should set it in your login config file.
if [ -z "$STATMT" ] ; then
  echo "You must set: "
  echo "  \$STATMT to the root of your working copy of the StatMT repository (one level above playground)"
  echo "  \$SRC to the code of the source language"
  echo "  \$TGT to the code of the target language"
  exit 1
fi
SCRIPTS=$STATMT/scripts
eman defvar SRC help='source language code' \
     defvar TGT help='target language code' \
|| exit 1

# Check that we know the language pair and can select data for it.
perl -e "\$s = $SRC; \$t = $TGT; "'die "Unknown language pair $s-$t" unless("$s-$t" =~ m/^(cs-en|en-cs|de-en|en-de|es-en|en-es|fr-en|en-fr)$/)' || exit 1
# Select the corpora according to the language pair.
if   [ "$SRC-$TGT" == "cs-en" ] || [ "$SRC-$TGT" == "en-cs" ] ; then
  TRAINTM=news-commentary-v6.cs-en+europarl-v6.cs-en
elif [ "$SRC-$TGT" == "de-en" ] || [ "$SRC-$TGT" == "en-de" ] ; then
  TRAINTM=news-commentary-v6.de-en+europarl-v6.de-en
elif [ "$SRC-$TGT" == "es-en" ] || [ "$SRC-$TGT" == "en-es" ] ; then
  TRAINTM=news-commentary-v6.es-en+europarl-v6.es-en
elif [ "$SRC-$TGT" == "fr-en" ] || [ "$SRC-$TGT" == "en-fr" ] ; then
  TRAINTM=news-commentary-v6.fr-en+europarl-v6.fr-en
fi
TRAINLM=$TRAINTM
DEV=newstest2008
TEST=newstest2011
TRAINALS=$TRAINTM/$SRC+lcstem4
TRAINALT=$TRAINTM/$TGT+lcstem4
TRAINTMS=$TRAINTM/$SRC+stc
TRAINTMT=$TRAINTM/$TGT+stc
TRAINLMT=$TRAINLM/$TGT+stc
DEVS=$DEV/$SRC+stc
DEVT=$DEV/$TGT+stc
TESTS=$TEST/$SRC+stc
TESTT=$TEST/$TGT+stc
# We still use the old augment.pl to fetch the data.
AUGMENT=$STATMT/playground/augmented_corpora/augment.pl
AUGMAKEFILE=$STATMT/playground/augmented_corpora/Makefile
AUGDIR=/net/work/people/zeman/wmt/augmented_corpora

# Set local bash variables.
eval `eman bash-loadvars`

# Don't continue if we are not preparing the step yet.
[ -z "$INIT_ONLY" ] || exit 0

# Tag the step by its prominent characteristics.
echo $SRC-$TGT > eman.tag

cat > eman.command << KONEC
#!/bin/bash
echo "=============================="
echo "== Started:   "\`date '+%Y%m%d-%H%M'\`
echo "== Hostname:  "\`hostname\`
echo "== Directory: "\`pwd\`
echo "=============================="
mydir=\$(pwd)
set -o pipefail
function die() { echo "\$@" >&2 ; eman fail \$mydir ; exit 1 ; }
renice 10 \$\$

# Note: the essential --dir and --makefile arguments must be stored in a file
# because augment.pl may call "make" and the Makefile will call another
# augment.pl, without being able to put through these arguments.
echo "--dir=$AUGDIR --makefile=$AUGMAKEFILE" > $STATMT/playground/augmented_corpora/augment.pl.flags || die "Failed to save augment.pl.flags"
ln -s \`$AUGMENT $TRAINALS\` trainal.$SRC.gz || die "Failed to link to $TRAINALS"
ln -s \`$AUGMENT $TRAINALT\` trainal.$TGT.gz || die "Failed to link to $TRAINALT"
ln -s \`$AUGMENT $TRAINTMS\` train.$SRC.gz   || die "Failed to link to $TRAINTMS"
ln -s \`$AUGMENT $TRAINTMT\` train.$TGT.gz   || die "Failed to link to $TRAINTMT"
ln -s \`$AUGMENT $TRAINLMT\` trainlm.$TGT.gz || die "Failed to link to $TRAINLMT"
ln -s \`$AUGMENT $DEVS\` dev.$SRC.gz         || die "Failed to link to $DEVS"
ln -s \`$AUGMENT $DEVT\` dev.$TGT.gz         || die "Failed to link to $DEVT"
ln -s \`$AUGMENT $TESTS\` test.$SRC.gz       || die "Failed to link to $TESTS"
ln -s \`$AUGMENT $TESTT\` test.$TGT.gz       || die "Failed to link to $TESTT"
# Clean training data and alignment of sentences of 100 or more words.
# Longer sentences sometimes make binarization fail.
$SCRIPTS/clean-corpus-dan.pl -min 1 -max 99 trainal.$SRC.gz trainal.$TGT.gz train.$SRC.gz train.$TGT.gz \\
|| die "Cannot clean corpus from empty or too long sentences"
for i in trainal.$SRC trainal.$TGT train.$SRC train.$TGT ; do
  mv $i.clean.gz $i.gz || die "Failed mv $i.clean.gz $i.gz"
done

# Standard command footer
echo Done.
eman succeed \$mydir
echo "=============================="
echo "== Ended:     "\`date '+%Y%m%d-%H%M'\`
echo "== Hostname:  "\`hostname\`
echo "== Directory: "\`pwd\`
echo "=============================="
KONEC
